!function(){"use strict";angular.module("ml.highcharts",["highcharts-ng","ml.common","ml.highcharts.tpls","ml.search","ui.bootstrap"])}(),function(){"use strict";angular.module("ml.highcharts").factory("HighchartsHelper",["$q","MLRest","MLSearchFactory",function(t,e,n){function r(t,e){var n={xCategoryAxis:t.xAxisCategoriesMLConstraint,xAxis:t.xAxisMLConstraint,yAxis:t.yAxisMLConstraint};return"$frequency"===t.xAxisCategoriesMLConstraint?n.frequecy="xCategory":"$frequency"===t.xAxisMLConstraint?n.frequecy="x":"$frequency"===t.yAxisMLConstraint?n.frequecy="y":"$frequency"===t.zAxisMLConstraint&&(n.frequecy="z"),n.xCategoryAxisIndex=e.indexOf(n.xCategoryAxis),n.xAxisIndex=e.indexOf(n.xAxis),n.yAxisIndex=e.indexOf(n.yAxis),n.yAxisIndex=e.indexOf(n.zAxis),n}function i(t,e){return _.filter(t,function(t){return t&&t.name&&e.indexOf(t.name)>-1&&t.range}).sort(function(t,n){return e.indexOf(t.name)-e.indexOf(n.name)})}function a(t,e,n,r){var i=_.map(n,function(t){return t.range}),a=[{name:"cooccurrence",range:i,"values-option":["frequency-order","limit="+(r?r:"20")]}],o={search:{options:{constraint:e},query:t?t.getQuery().query:{queries:[]}}};return n.length>1?o.search.options.tuples=a:o.search.options.values=a,o}var o={};return o.seriesData=function(t,e,n){var r=[];if(n.length){var i={};angular.forEach(t,function(t){i[t.x]||(i[t.x]=[]);var e=n.indexOf(t.xCategory);i[t.x][e]=[t.xCategory,t.y]}),angular.forEach(i,function(t,i){angular.forEach(n,function(e,n){t[n]||(t[n]=[e,0])}),r.push({type:e,name:i,data:t})})}else r="pie"===e?[{type:e,data:t}]:"bubble"===e?_.map(t,function(t){return{type:e,name:t.name,data:[[t.x,t.y,t.z]]}}):_.map(t,function(t){return{type:e,name:t.x,data:[t.y]}});return r},o.chartFromConfig=function(t,e,r,i){var a=t.options.chart.type,s=angular.copy(t);return e||(e=n.newContext()),e.getStoredOptions("all").then(function(n){if(n.options&&n.options.constraint){var i=_.filter(n.options.constraint,function(t){var e=t.range||t.collection;return e&&e.facet});o.getChartData(e,r,i,t,t.resultLimit).then(function(t){s.series=o.seriesData(t.data,a,t.categories),t.categories&&t.categories.length&&(s.xAxis.categories=t.categories)})}}),i&&(s.options.plotOptions={series:{cursor:"pointer",point:{events:{click:function(){var t=this.name||this.series.name;i(1===t.data.length?{facet:t.data[0].__key,value:t}:{facet:this.series.name,value:t})}}}}}),s},o.getChartData=function(n,o,s,c,l){var h=[c.xAxisCategoriesMLConstraint,c.xAxisMLConstraint,c.yAxisMLConstraint],u=[];if(s&&s.length){var x=i(s,h),g=_.map(x,function(t){return t.name}),f=r(c,g);if(console.log("mlSearchController"),console.log(o),console.log("filteredConstraintNames"),console.log(g),o&&g.length<=1){var C=t.defer(),y=o.response.facets,m=[],p=g[0],d=y[p];if(d&&d.facetValues)for(var A in d.facetValues){var v=d.facetValues[A],L={x:f.xAxisIndex>-1?v.value:null,y:f.yAxisIndex>-1?v.value:null,z:f.zAxisIndex>-1?v.value:null};L.name=L.x||L.y,L[f.frequecy]=v.count,m.push(L)}return C.resolve({data:m,categories:u}),C.promise}var M=a(n,s,x,l);return e.values("cooccurrence",{format:"json"},M).then(function(t){var e=[];return t.data["values-response"]&&(x.length>1?angular.forEach(t.data["values-response"].tuple,function(t){var n=t["distinct-value"],r={xCategory:n[f.xCategoryAxisIndex]?n[f.xCategoryAxisIndex]._value:null,x:n[f.xAxisIndex]?n[f.xAxisIndex]._value:null,y:n[f.yAxisIndex]?n[f.yAxisIndex]._value:null,z:n[f.zAxisIndex]?n[f.zAxisIndex]._value:null};r.xCategory&&u.indexOf(r.xCategory)<0&&u.push(r.xCategory),r.name=_.without([r.xCategory,r.x,r.y,r.z],null,void 0).join(),r[f.frequecy]=t.frequency,e.push(r)}):angular.forEach(t.data["values-response"]["distinct-value"],function(t){var n={x:f.xAxisIndex>-1?t._value:null,y:f.yAxisIndex>-1?t._value:null};n.name=n.x||n.y,n[f.frequecy]=t.frequency,e.push(n)})),{data:e,categories:u}})}var S=t.defer();return S.resolve(null),S.promise},o.chartTypes=function(){return["line","spline","area","areaspline","column","bar","bubble","pie","scatter"]},o}])}(),function(){"use strict";angular.module("ml.highcharts").directive("mlHighchart",["$q","HighchartsHelper","MLRest","MLSearchFactory",function(t,e,n,r){function i(t,n,i){t.mlSearchController&&!t.mlSearch&&(t.mlSearch=t.mlSearchController.mlSearch,console.warn("Please link mlSearch in mlHighCharts directive")),t.mlSearch||(t.mlSearch=r.newContext());var a=function(){t.highchartConfig&&(t.populatedConfig=e.chartFromConfig(t.highchartConfig,t.mlSearch,t.mlSearchController,t.callback))},o=function(t){return function(){var e=t.apply(this,arguments);return e&&angular.isFunction(e.then)?e.then(function(t){return a(),t}):(a(),e)}};if(t.mlSearchController){var s=t.mlSearchController.updateSearchResults;t.mlSearchController.updateSearchResults=o(s),a()}else{var c=t.mlSearch.search;t.mlSearch.search=o(c),a()}}return{restrict:"E",templateUrl:"/ml-highcharts/templates/ml-highchart.html",scope:{mlSearch:"=",mlSearchController:"=",highchartConfig:"=",callback:"&"},link:i}}])}(),function(){"use strict";angular.module("ml.highcharts").controller("EditChartConfigCtrl",["$modalInstance","$scope","HighchartsHelper","facets","highchartConfig","MLSearchFactory",function(t,e,n,r,i,a){e.facetSortOptions={},e.xSortOptions={accept:function(t,e){return e.modelValue.length<1}},e.chartFacetOptions=Object.keys(r);var o=e.chartFacetOptions[0];e.chartFacetOptions.splice(0,1),e.facets=r,e.highchartConfig=i||{options:{chart:{type:"bar"},tooltip:{style:{padding:10,fontWeight:"bold"}}},title:{text:"Title"},xAxis:{title:{text:o}},xAxisMLConstraint:o,xAxisCategoriesMLConstraint:null,yAxis:{title:{text:null}},yAxisMLConstraint:"$frequency",zAxis:{title:{text:null}},size:{height:250},resultLimit:15},e.highchartConfig.xAxis||(e.highchartConfig.xAxis={title:{text:null}}),e.highchartConfig.yAxis||(e.highchartConfig.yAxis={title:{text:null}}),e.xAxisMLConstraint=[e.highchartConfig.xAxisMLConstraint],e.xAxisCategoriesMLConstraint=[e.highchartConfig.xAxisCategoriesMLConstraint],e.yAxisMLConstraint=[e.highchartConfig.yAxisMLConstraint];var s=function(){e.previewHighChart=n.chartFromConfig(e.highchartConfig)};e.chartTypes=n.chartTypes(),s(),e.$watch(function(){return e.highchartConfig.options.chart.type+e.highchartConfig.xAxis.title.text+e.highchartConfig.yAxis.title.text+e.highchartConfig.title.text+e.highchartConfig.resultLimit},function(){s()}),e.$watch(function(){return e.xAxisMLConstraint.length+""+e.yAxisMLConstraint.length+e.xAxisCategoriesMLConstraint.length},function(){e.highchartConfig.xAxisMLConstraint=e.xAxisMLConstraint[0],e.highchartConfig.yAxisMLConstraint=e.yAxisMLConstraint[0],e.highchartConfig.xAxisCategoriesMLConstraint=e.xAxisCategoriesMLConstraint[0],s()}),e.save=function(){t.close(e.highchartConfig)}}]).factory("EditChartConfigDialog",["$modal",function(t){return function(e,n){return t.open({templateUrl:"/ml-highcharts/templates/ml-highchart-config-modal.html",controller:"EditChartConfigCtrl",size:"lg",resolve:{facets:function(){return e},highchartConfig:function(){return n}}}).result}}])}();